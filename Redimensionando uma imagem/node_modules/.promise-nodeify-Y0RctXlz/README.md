promise-nodeify
===============

[![Build Status: Linux](https://img.shields.io/travis/kevinoid/promise-nodeify/master.svg?style=flat&label=build+on+linux)](https://travis-ci.org/kevinoid/promise-nodeify)
[![Build Status: Windows](https://img.shields.io/appveyor/ci/kevinoid/promise-nodeify/master.svg?style=flat&label=build+on+windows)](https://ci.appveyor.com/project/kevinoid/promise-nodeify)
[![Coverage](https://img.shields.io/codecov/c/github/kevinoid/promise-nodeify.svg?style=flat)](https://codecov.io/github/kevinoid/promise-nodeify?branch=master)
[![Dependency Status](https://img.shields.io/david/kevinoid/promise-nodeify.svg?style=flat)](https://david-dm.org/kevinoid/promise-nodeify)
[![Supported Node Version](https://img.shields.io/node/v/promise-nodeify.svg?style=flat)](https://www.npmjs.com/package/promise-nodeify)
[![Version on NPM](https://img.shields.io/npm/v/promise-nodeify.svg?style=flat)](https://www.npmjs.com/package/promise-nodeify)

Call a Node-style callback with the resolution value or rejection cause of a
Promise without the common pitfalls.

## Introductory Example

```js
var promiseNodeify = require('promise-nodeify');

// Function which returns a Promise
function returnsPromise() {
  return new Promise(function(resolve, reject) {
    resolve(42);
  });
}

// Function which takes an optional node-style callback
function takesCallback(callback) {
  var promise = returnsPromise();
  // if callback is not a function, promise is returned as-is
  // otherwise callback will be called when promise is resolved or rejected
  // promise will not cause unhandledRejection if callback is a function
  return promiseNodeify(promise, callback);
}
```

## Features

The important features of `nodeify` as compared to naive implementations:

* Creates `Error` for falsey rejection causes.  Since Promises may resolve or
  reject without providing a value or cause, the callback would have no way to
  distinguish success from failure.  This module ensures the error argument is
  always truthy, substituting an `Error` when the rejection cause is falsey
  (and passing the original value as the `.cause` property, as bluebird does).
* Exceptions thrown by callback cause `uncaughtException` as they would for
  other callbacks (unlike passing callback to `.then`, which causes
  `unhandledRejection` or swallows them).
* The callback handles the promise rejection, preventing `unhandledRejection`
  (unlike if the promise were ignored and callback invoked directly).
* Reduces confusion by only returning a Promise when no callback is given
  (as opposed to returning the promise argument, which creates uncertainty
  about `unhandledRejection`s and multiple threads of control - or returning
  the result passing the callback to `.then`, which resolves to the callback
  result).

## Behavior Comparison

This module provides similar behavior to several popular promise libraries in
a promise-library-agnostic way which only requires the ES6 promise
functionality subset.  However, these existing implementations differ in
subtle ways.  A brief comparison:

Behavior                  | this module           | [bluebird `#asCallback`][bb-ascallback]      | [es-nodeify][es-nodeify]              | [nodeify][nodeify]                    | [then `#nodeify`][then-nodeify] | [Un-thenify][unthenify]<sup>[1](#note-1)</sup> | [when.js `.bindCallback`][when-bindcallback]
--------------------------|-----------------------|----------------------------------------------|---------------------------------------|---------------------------------------|---------------------------------|------------------------------------------------|---------------------------------------------
returns (with `function`) | `undefined`           | `this` `Promise`<sup>[2](#note-2)</sup>      | `undefined`                           | `Promise<undefined>`                  | `undefined`                     | `undefined`                                    | `when(promise)`
returns (with falsey)     | `promise`             | `promise`                                    | `promise`                             | `Promise<undefined>`                  | `promise`                       | `undefined` with `unhandledRejection`          | `when(promise)`
returns (non-function)    | `promise`             | `promise`                                    | `undefined` with `unhandledRejection` | `promise`                             | `promise`                       | `undefined` with `unhandledRejection`          | `when(promise)` with `uncaughtException`
callback exception        | `uncaughtException`   | `uncaughtException`                          | `unhandledRejection`                  | `uncaughtException`                   | `uncaughtException`             | `unhandledRejection`                           | `uncaughtException`
falsey cause              | `Error` with `.cause` | `Error` with `.cause`<sup>[3](#note-3)</sup> | `Error`                               | falsey cause                          | falsey cause                    | `TypeError`                                    | falsey cause
reject argument length    | 1                     | 1                                            | 1                                     | 1                                     | 1                               | 1                                              | 2
resolve argument length   | 2                     | `undefined` ? 1 : 2<sup>[4](#note-4)</sup>   | 2                                     | 2                                     | 2                               | 2                                              | 2
extra argument            | ignored               | options<sup>[5](#note-5)</sup>               | ignored                               | ignored                               | `this` of callback              | ignored                                        | ignored

Notes:

1. <a id="note-1" name="note-2" /> Un-thenify serves a similar purpose, but
   wraps the Promise-returning function rather than taking the Promise as an
   argument.
2. <a id="note-2" name="note-3" /> Temporarily reverted in
   https://github.com/petkaantonov/bluebird/issues/151 and restored in
   https://github.com/petkaantonov/bluebird/issues/168
3. <a id="note-3" name="note-4" /> In response to
   https://github.com/petkaantonov/bluebird/issues/434
4. <a id="note-4" name="note-5" /> In response to
   https://github.com/petkaantonov/bluebird/issues/170
5. <a id="note-5" name="note-6" /> Supports the `spread` boolean option to
   pass `Array` values as separate arguments to `callback`.

## Performance Comparison

These benchmarks were done using the [benchmark/index.js](benchmark/index.js)
script on an `Intel(R) Core(TM) i5-3320M CPU @ 2.60GHz` with Node v4.3.1 on
Linux and the following module versions:

| Module                                           | Version |
|--------------------------------------------------|---------|
| [`benchmark`][npm-benchmark]                     | 2.1.0   |
| [`bluebird`][npm-bluebird]                       | 3.3.3   |
| [`cli-table`][npm-cli-table]                     | 0.3.1   |
| [`es-nodeify`][npm-es-nodeify]                   | 1.0.0   |
| [`microtime`][npm-microtime]                     | 2.0.0   |
| [`native-promise-only`][npm-native-promise-only] | 0.8.1   |
| [`nodeify`][npm-nodeify]                         | 1.0.0   |
| [`pinkie-promise`][npm-pinkie-promise]           | 2.0.0   |
| [`promise`][npm-promise]                         | 7.1.1   |
| [`q`][npm-q]                                     | 1.4.1   |
| [`rsvp`][npm-rsvp]                               | 3.2.1   |
| [`unthenify`][npm-unthenify]                     | 1.0.1   |
| [`when`][npm-when]                               | 3.7.7   |

### Nodeify Resolved Promise

Performance (in operations per second) of calling `nodeify` on a resolved
promise (larger is better):

| ops/sec           | bluebird      | native      | npo         | pinkie      | q          | rsvp          | then          | when          |
|-------------------|--------------:|------------:|------------:|------------:|-----------:|--------------:|--------------:|--------------:|
| bluebird#nodeify  | 1,922,721.987 | TypeError   | TypeError   | TypeError   | TypeError  | TypeError     | TypeError     | TypeError     |
| es-nodeify        | 1,345,702.588 | 506,103.345 | 510,887.217 | 534,013.961 | 68,915.816 | 1,974,250.737 | 2,096,468.119 | 1,756,177.934 |
| nodeify           | 147,481.019   | 251,414.264 | 251,535.145 | 253,880.998 | 58,504.098 | 1,355,812.482 | 1,102,467.756 | 1,160,226.624 |
| promiseNodeify    | 1,586,092.279 | 481,842.79  | 452,529.247 | 455,657.062 | 66,045.273 | 2,108,607.126 | 2,370,823.723 | 1,942,722.539 |
| then#nodeify      | 136,716.987   | 202,670.23  | 225,297.257 | 231,042.286 | 56,384.953 | 764,719.55    | 1,320,158.92  | 739,062.155   |
| unthenify         | 100,638.922   | 79,097.99   | 80,488.25   | 78,298.365  | 40,683.82  | 103,125.162   | 100,618.139   | 101,887.997   |
| when.bindCallback | 823.326       | 856.669     | 842.975     | 834.864     | 748.669    | 847.556       | 850.316       | 839.995       |

<!-- GitHub sanitizes my attempts to make this toggleable.  Hide for now.
    bluebird#nodeify with bluebird x 1,922,722 ops/sec ±1.71% (80 runs sampled)
    bluebird#nodeify with npo: TypeError: this._then is not a function
    bluebird#nodeify with pinkie: TypeError: this._then is not a function
    bluebird#nodeify with q: TypeError: this._then is not a function
    bluebird#nodeify with rsvp: TypeError: this._then is not a function
    bluebird#nodeify with then: TypeError: this._then is not a function
    bluebird#nodeify with when: TypeError: this._then is not a function
    bluebird#nodeify with native: TypeError: this._then is not a function
    es-nodeify with bluebird x 1,345,703 ops/sec ±0.84% (81 runs sampled)
    es-nodeify with npo x 510,887 ops/sec ±1.32% (85 runs sampled)
    es-nodeify with pinkie x 534,014 ops/sec ±0.92% (84 runs sampled)
    es-nodeify with q x 68,916 ops/sec ±2.99% (70 runs sampled)
    es-nodeify with rsvp x 1,974,251 ops/sec ±0.84% (85 runs sampled)
    es-nodeify with then x 2,096,468 ops/sec ±0.77% (84 runs sampled)
    es-nodeify with when x 1,756,178 ops/sec ±3.48% (82 runs sampled)
    es-nodeify with native x 506,103 ops/sec ±1.36% (87 runs sampled)
    nodeify with bluebird x 147,481 ops/sec ±2.80% (71 runs sampled)
    nodeify with npo x 251,535 ops/sec ±2.60% (77 runs sampled)
    nodeify with pinkie x 253,881 ops/sec ±2.53% (67 runs sampled)
    nodeify with q x 58,504 ops/sec ±4.30% (67 runs sampled)
    nodeify with rsvp x 1,355,812 ops/sec ±2.98% (81 runs sampled)
    nodeify with then x 1,102,468 ops/sec ±2.09% (81 runs sampled)
    nodeify with when x 1,160,227 ops/sec ±3.95% (79 runs sampled)
    nodeify with native x 251,414 ops/sec ±3.02% (77 runs sampled)
    promiseNodeify with bluebird x 1,586,092 ops/sec ±1.94% (81 runs sampled)
    promiseNodeify with npo x 452,529 ops/sec ±0.52% (84 runs sampled)
    promiseNodeify with pinkie x 455,657 ops/sec ±0.50% (85 runs sampled)
    promiseNodeify with q x 66,045 ops/sec ±4.14% (71 runs sampled)
    promiseNodeify with rsvp x 2,108,607 ops/sec ±3.66% (81 runs sampled)
    promiseNodeify with then x 2,370,824 ops/sec ±1.08% (82 runs sampled)
    promiseNodeify with when x 1,942,723 ops/sec ±0.79% (86 runs sampled)
    promiseNodeify with native x 481,843 ops/sec ±0.41% (87 runs sampled)
    then#nodeify with bluebird x 136,717 ops/sec ±1.83% (82 runs sampled)
    then#nodeify with npo x 225,297 ops/sec ±2.92% (81 runs sampled)
    then#nodeify with pinkie x 231,042 ops/sec ±2.14% (80 runs sampled)
    then#nodeify with q x 56,385 ops/sec ±3.88% (75 runs sampled)
    then#nodeify with rsvp x 764,720 ops/sec ±3.37% (81 runs sampled)
    then#nodeify with then x 1,320,159 ops/sec ±2.67% (81 runs sampled)
    then#nodeify with when x 739,062 ops/sec ±0.78% (85 runs sampled)
    then#nodeify with native x 202,670 ops/sec ±6.14% (74 runs sampled)
    unthenify with bluebird x 100,639 ops/sec ±2.24% (84 runs sampled)
    unthenify with npo x 80,488 ops/sec ±2.78% (84 runs sampled)
    unthenify with pinkie x 78,298 ops/sec ±3.08% (81 runs sampled)
    unthenify with q x 40,684 ops/sec ±3.94% (73 runs sampled)
    unthenify with rsvp x 103,125 ops/sec ±0.78% (84 runs sampled)
    unthenify with then x 100,618 ops/sec ±3.56% (83 runs sampled)
    unthenify with when x 101,888 ops/sec ±0.46% (82 runs sampled)
    unthenify with native x 79,098 ops/sec ±3.09% (83 runs sampled)
    when.bindCallback with bluebird x 823 ops/sec ±1.21% (76 runs sampled)
    when.bindCallback with npo x 843 ops/sec ±0.96% (75 runs sampled)
    when.bindCallback with pinkie x 835 ops/sec ±0.97% (75 runs sampled)
    when.bindCallback with q x 749 ops/sec ±1.55% (73 runs sampled)
    when.bindCallback with rsvp x 848 ops/sec ±0.94% (77 runs sampled)
    when.bindCallback with then x 850 ops/sec ±0.86% (76 runs sampled)
    when.bindCallback with when x 840 ops/sec ±0.86% (76 runs sampled)
    when.bindCallback with native x 857 ops/sec ±1.41% (38 runs sampled)
-->

### Nodeify Rejected Promise

Performance (in operations per second) of calling `nodeify` on a rejected
promise (larger is better):


| ops/sec           | bluebird      | native      | npo         | pinkie      | q          | rsvp          | then          | when          |
|-------------------|--------------:|------------:|------------:|------------:|-----------:|--------------:|--------------:|--------------:|
| bluebird#nodeify  | 1,889,496.469 | TypeError   | TypeError   | TypeError   | TypeError  | TypeError     | TypeError     | TypeError     |
| es-nodeify        | 1,247,981.228 | 520,349.959 | 455,337.77  | 466,964.692 | 64,703.247 | 2,182,281.005 | 2,062,330.035 | 1,889,184.935 |
| nodeify           | 147,454.87    | 325,956.476 | 326,958.556 | 325,971.637 | 53,878.098 | 1,232,726.201 | 952,338.091   | 926,626.949   |
| promiseNodeify    | 1,170,